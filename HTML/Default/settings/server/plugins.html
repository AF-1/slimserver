[% descHeight = 65 %]
[% iconSize = 50 %]
[% IF useExtJS; extJsScripts = BLOCK %]
<script TYPE="text/javascript">
	var categories = [% categories %];
	var searchData = [% searchData %];
	var category, search, collapsableSections = [];

	Ext.onReady(function() {
		[% PROCESS jsString id='SETUP_EXTENSIONS_WARNING_POPUP' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_WARNING_POPUP2' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_WARNING_POPUP_OTHERREPO' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_ALL' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_DATABASE', jsId='database' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_HARDWARE', jsId='hardware' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_INFO' jsId='information' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_MISC' jsId='misc' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_MUSICSERVICES' jsId='musicservices' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_PLAYLISTS' jsId='playlists' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_RADIO' jsId='radio' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_SCANNING' jsId='scanning' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_SKIN' jsId='skin' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_TOOLS' jsId='tools' %]

		if (SqueezeJS.UI) {
			// plugin filtering
			var filterChooser = new SqueezeJS.UI.SplitButton({
				renderTo: 'filterChooser',
				menu: new Ext.menu.Menu({shadow: Ext.isGecko && Ext.isMac ? true : 'sides'}),
				text: SqueezeJS.string('setup_extensions_category_all')
			});

			Ext.each(categories.sort(function(a, b) {
				a = SqueezeJS.string(a || 'setup_extensions_category_all');
				b = SqueezeJS.string(b || 'setup_extensions_category_all');

				if (a < b) return -1
				else if (b < a) return 1
				else return 0;
			}), function(category, x) {
				filterChooser.menu.add(
					new Ext.menu.CheckItem({
						text: category ? SqueezeJS.string(category) : SqueezeJS.string('setup_extensions_category_all'),
						value: category,
						checked: false,
						cls: 'settingsList',
						group: 'settingsList',
						handler: function(ev) {
							Ext.get('filterInput').dom.value = '';
							expandAllSections();

							category = ev.value;
							filterChooser.setText(category ? SqueezeJS.string(category) : SqueezeJS.string('setup_extensions_category_all'));
							togglePluginVisibility(category, function(s) {
								return s.category == category;
							});
						}
					})
				);
			});

			new Ext.form.TextField({
				applyTo: 'filterInput',
				validationDelay: 100,
				validateOnBlur: false,
				selectOnFocus: true,

				validator: function(value) {
					filterChooser.setText(SqueezeJS.string('setup_extensions_category_all'));
					expandAllSections();

					var reg = new RegExp(value, 'i');
					togglePluginVisibility(value, function(s) {
						return reg.test(s.content);
					});
				}
			});

			var pluginDescriptions = Ext.query('div.pluginDesc');
			Ext.each(pluginDescriptions, function(descEl) {
				descEl = Ext.get(descEl);
				if (descEl.getHeight() > [% descHeight %]) {
					descEl.addClass('pluginDescLong');
					new Ext.ToolTip({
						target: descEl,
						html: descEl.dom.innerHTML,
						hideDelay: 1500,
						maxWidth: 300
					});
				}
			});

			function togglePluginVisibility(value, validator) {
				var pluginItems = Ext.query('li.thumbwrap');

				if (!value) {
					Ext.each(pluginItems, function(item) {
						Ext.get(item).setDisplayed(true);
					});
				}
				else {
					Ext.each(pluginItems, function(item) {
						var id = item.id.replace('plugin-', '');
						item = Ext.get(item);

						let s = searchData[id];

						if (s && validator(s)) {
							item.setDisplayed(true);
						}
						else {
							item.setDisplayed(false);
						}
					});
				}
			}

			function expandAllSections() {
				collapsableSections.forEach(function(section) {
					Settings.Page.expandItem(section[0], section[1]);
				});
			}
		}

		Settings.Page.submit = function(ajax, cb) {
			// display warning if user wants to install "unsafe" plugins from 3rd parties or add the other repo
			var unsafe = Ext.query('input.unsafePlugin');
			var other  = Ext.query('input.otherrepo');
			var msg    = '';

			for (var i = 0; i < unsafe.length; i++) {
				if (unsafe[i].checked)
					msg += '<li>' + unsafe[i].value + '</li>';
			}

			if (msg > '') {
				msg = SqueezeJS.string('plugin_extensions_warning_popup')
						+ '<ul>' + msg + '</ul>'
						+ SqueezeJS.string('plugin_extensions_warning_popup2');
			}

			if (other.length > 0) {
				if (other[0].checked) {
					msg = SqueezeJS.string('plugin_extensions_warning_popup_otherrepo');
				}
			}

			if (msg > '') {
				Ext.Msg.show({
					title: SqueezeJS.string('settings'),
					msg: msg,
					width: 450,
					closable: false,
					buttons: Ext.Msg.OKCANCEL,
					fn: function(btn) {
						if (btn == 'ok') {
							document.forms.settingsForm.submit();
						}
					}
				});
			}

			else {
				document.forms.settingsForm.submit();
			}
		};

		collapsableSections = Settings.Page.initCollapsableItems('grid');
	});
</script>
[% END; END %]
<style>
	.pluginItem img.pluginFallbackIcon {
		border: 1px solid #bbb;
		border-radius: 5px;
		background-color: #eee;
		padding: 2px;
		width: [% iconSize - 6 %]px !important;
	}

	.pluginList .pluginDesc, .pluginFooter {
		max-height: [% descHeight %]px !important;
	}

	.pluginList .pluginDescLong:before {
		position: absolute;
		content: '';
		width: 100%;
		height: 100%;
		left: 0;
		top: 0;
		background: linear-gradient(transparent [% descHeight - 30 %]px, white) !important;
	}

	#pluginButtonBar #filterChooser {
		width: 200px;
	}

	#pluginButtonBar span {
		vertical-align: top;
	}

	#pluginButtonBar .x-form-text {
		height: 20px;
	}
</style>
[% PROCESS settings/server/plugins_main.html %]

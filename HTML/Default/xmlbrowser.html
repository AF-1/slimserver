[%- 
hasArtwork = 0;
contentwrapper = 'contentitem';
container = 'contentcontainer';
artwork = artwork ? artwork : 0;

IF ajaxUpdate && ajaxUpdate >= 1;
	container = 'dummycontainer';
ELSE;
	FOREACH item = items;
		IF item.image;
			hasArtwork = 1;
			LAST;
		END;	
	END;	
END;

IF hasArtwork;
	IF artwork == 1;
		container = 'gallerycontainer';
		contentwrapper = 'galleryitem';
	END;
	
	titleRight = BLOCK %]
		<div id="viewSelect"></div>
	[% END; 
END %]

[%- extJsScripts = BLOCK -%]
	<script type="text/javascript">
		[% IF hasArtwork %]
			[% PROCESS jsString id='SWITCH_TO_LIST' jsId='switch_to_list' %]
			[% PROCESS jsString id='SWITCH_TO_EXTENDED_LIST' jsId='switch_to_extended_list' %]
			[% PROCESS jsString id='SWITCH_TO_GALLERY' jsId='switch_to_gallery' %]
			[% PROCESS jsString id='ALBUM_DISPLAY_OPTIONS' jsId='display_options' %]
		[% END %]

		var orderByList;
		[% IF orderByList %]
			orderByList = {};
			[% PROCESS jsString id='SORT_BY' jsId='sort_by' %]
			[% FOREACH key = orderByList.keys.sort %]
				orderByList["[% key | string %]"] = '[% orderByList.$key | replace("'", "%27") %]';
			[% END %]
		[% END %]
			
		Ext.onReady(function(){
			Browse.init();
		});
	</script>
[% END %]

[% IF query %]
	[%# Add the search query to each link if available %]
	[% searchquery = 'query=' _ query _ '&amp;' %]
[% END %]
[% IF mquery %]
	[%# Add the search query to each link if available %]
	[% multiquery = mquery _ '&amp;' %]
[% END %]


[% FILTER null %]
[% pwd_list = [];
	FOREACH crumb IN crumb;
		crumbItem = BLOCK %]
			<a href="[% path %]?[% multiquery %][% searchquery | replace("'", "%27") | uri %]player=[% playerURI %]&amp;index=[% crumb.index %]&amp;sess=[% sess %]">[% crumb.name %]</a>
		[% END %]
		[% pwd_list.push(crumbItem) %]
	[% END %]
[% END # filter -%]

[% IF NOT ajaxUpdate %][% PROCESS pageheader.html dontscroll = (streaminfo ? 0 : 1) useSpecialExt="-browse" %][% IF !streaminfo %]<div id="mainbody">[% END %][% END %]

[% IF msg %][% WRAPPER contentcontainer %]
	<div class="message">[% msg %]</div>
[% END %][% END %]

[% IF streaminfo %]
	[% IF streaminfo.item.enclosure || streaminfo.item.url; songInfoPlayLinks = BLOCK %]
	<div id="songInfoPlayLinks">
		[% WRAPPER playlink %]onclick="Browse.XMLBrowser.playLink('[% multiquery %][% searchquery | replace("'", "%27") | uri %]', '[% streaminfo.index %]', '[% sess %]');"[% END %]
		[% WRAPPER addlink %]onclick="Browse.XMLBrowser.addLink('[% multiquery %][% searchquery | replace("'", "%27") | uri %]', '[% streaminfo.index %]', '[% sess %]');"[% END %]
	</div>
	[% END; END %]

	[% PROCESS xmlbrowser_details.html %]
[% END %]

[%- IF items.size -%]

	<div id="browsedbHeader">
		[% IF hasPagebar %]
			<div class="pagerbox">
				<div class="pagerbox_top"><div></div></div>
				<div class="pagerbox_content">
					[% PROCESS pagebar %]
				</div>
				<div class="pagerbox_bottom"><div></div></div>
			</div>
		[% END %]
	</div>

	[%- BLOCK gencontrol -%]
		[% IF item.favorites == 1 %]
			[% WRAPPER favaddlink noTarget=1 %]
				onclick="Browse.XMLBrowser.toggleFavorite(this, '[% (item.index || index _ (start + loop.index)) | replace("'", "%27") | uri %]', '[% pageinfo.startitem %]', '[% sess %]');"
			[% END %]
		[% ELSIF item.favorites == 2 %]
			[% WRAPPER favdellink noTarget=1 %]
				onclick="Browse.XMLBrowser.toggleFavorite(this, '[% (item.index || index _ (start + loop.index)) | replace("'", "%27") | uri %]', '[% pageinfo.startitem %]', '[% sess %]');"
			[% END %]
		[% END %]

		[% IF item.playLink %]
			[% WRAPPER playlink %]onclick="SqueezeJS.Controller.urlRequest('[% webroot %][% item.playLink %]&player=[% player | uri %]', 0, SqueezeJS.string('connecting_for'));"[% END %]
			[% IF item.addLink; WRAPPER addlink %]onclick="SqueezeJS.Controller.urlRequest('[% webroot %][% item.addLink %]&player=[% player | uri %]', 0);"[% END; END %]
		[% ELSIF item.type == 'audio' || item.type == 'playlist' || item.enclosure || item.play %]
			[% WRAPPER playlink %]onclick="Browse.XMLBrowser.play[% IF item.type == 'playlist' %]All[% END %]Link('[% multiquery %][% searchquery | replace("'", "%27") | uri %]', '[% (item.index || index _ (start + loop.index)) | replace("'", "%27") | uri %]', '[% sess %]');"[% END %]
			[% WRAPPER addlink %]onclick="Browse.XMLBrowser.add[% IF item.type == 'playlist' %]All[% END %]Link('[% multiquery %][% searchquery | replace("'", "%27") | uri %]', '[% (item.index || index _ (start + loop.index)) | replace("'", "%27") | uri %]', '[% sess %]');"[% END %]
		[% ELSE %]
			[% PROCESS dummylink %]
			[% PROCESS dummylink %]
		[% END %]
	[%- END %]

	[%- BLOCK allcontrol -%]
		[% WRAPPER playlink %]onclick="Browse.XMLBrowser.playAllLink('[% multiquery %][% searchquery | replace("'", "%27") | uri %]', '[% currentIndex %]', '[% sess %]');"[% END %]
		[% WRAPPER addlink %]onclick="Browse.XMLBrowser.addAllLink('[% multiquery %][% searchquery | replace("'", "%27") | uri %]', '[% currentIndex %]', '[% sess %]');"[% END %]
	[%- END %]

	[%- IF songinfo;
		songInfoPlayLinks = BLOCK %]
		<div id="songInfoPlayLinks">
			[% IF songinfo.playLink; PROCESS gencontrol item = songinfo; ELSIF itemsHaveAudio; PROCESS allcontrol; END %]
		</div>
		[% END;	
		PROCESS songinfo_header.html itemobj = songinfo;
		image = undef;
	END %]


	[%- WRAPPER $container %]
		[% IF image %]
		<div>
			<a href="[% UNLESS image.match("^(\/|http)") %][% webroot %][% END %][% image %]" target="cover">
				<img src="[% image | resizeimage(150, 150, '', webroot) %]" alt="coverArt">
			</a>
		</div>
		[% END %]

		[% IF itemsHaveAudio && !songinfo %]
			[%- BLOCK allcontrol -%]
				[% WRAPPER playlink %]onclick="Browse.XMLBrowser.playAllLink('[% multiquery %][% searchquery | replace("'", "%27") | uri %]', '[% currentIndex %]', '[% sess %]');"[% END %]
				[% WRAPPER addlink %]onclick="Browse.XMLBrowser.addAllLink('[% multiquery %][% searchquery | replace("'", "%27") | uri %]', '[% currentIndex %]', '[% sess %]');"[% END %]
			[%- END %]
			[%- WRAPPER contentitem controls = 'allcontrol' %]
				[% "ALL_SONGS" | string %]
			[%- END %]
		[% END %]

		[%- FOREACH item = items %]
		
			[% IF item.ignore; NEXT; END %]

			[% lctype = item.web.group | lower; IF details.${ lctype } || details.contributors.${item.web.group}; NEXT; END %]

			[% IF item.type == 'search' && !item.weblink;
				WRAPPER contentitem controls = xmlSearchControls;
					IF artwork == 1;
						itemobj.id = loop.count;
					END;
					item.name || item.title %]
					<span class="browsedbControls">
						<form id="searchForm[% item.index || index _ (start + loop.index) %]" method="GET">
							<input type="hidden" value="[% player %]" name="player" />
							<input type="hidden" value="[% sess %]" name="sess" />
							<input type="hidden" value="[% item.index || index _ (start + loop.index) %]" name="index" />
		 					<input type="hidden" name="submit" class="stdclick" value="[% "SEARCH" | string %]"/>
							<input type="text" class="x-form-focus searchInput" name="q" value=""/>
							<input type="image" src="[% webroot %]html/images/b_search.gif" width="17px" height="17px" alt="[% "SEARCH" | string %]">
						</form>
					</span>					
				[% END %]
			[% ELSE %]
				[%- WRAPPER $contentwrapper controls = 'gencontrol' addClasses = (item.type=='text' ? 'defaultCursor' : '') _ (item.icon ? ' smallIcon' : '') anchor = item.anchor %]
					[% IF artwork == 1 || path == 'trackinfo.html';
						item.size = thumbSize || 100;
						itemobj.id = loop.count _ (ajaxUpdate ? index : '');
					END %]

					[% IF item.image %]
						[% IF artwork == 0 %]
							[% PROCESS itemIcon url=item.image size=50 class="browseItemDetail" %]
						[% END %]
					[% ELSIF item.icon && artwork != 1 %]
						[% IF hasArtwork && artwork == 0 %]
							[% PROCESS itemIcon url=item.icon size=50 class="browseItemDetail" %]
						[% ELSE %]
							[% PROCESS itemIcon url=item.icon size=25 class="smallBrowseItemDetail" %]
						[% END %]
					[% END %]

					[% IF item.web.type == 'htmltemplate' %]
						[% PROCESS $item.web.value %]
					[% ELSE %]
						[% IF item.label %]
							[% item.label | string %]
							[%- "COLON" | string %]
						[% END %]	
						[% WRAPPER weblink %]
							[% (item.web.value || item.name || item.title) | html_line_break %]
						[% END %]
						[% IF item.showYear && item.year %]
							[% IF item.remote %]
								([% item.year %])
							[% ELSE %]
								<br><a [% PROCESS yearItemHRef %] class="browseItemLink">([% item.year %])</a>
							[% END %]
						[% END %]
						[% IF item.showArtist && item.artist %]
							[% IF item.artist_id %]
								<br><a [% PROCESS artistItemHRef %] class="browseItemLink">[% item.artist %]</a>
							[% ELSE %]
								<br>[% item.artist %]
							[% END %]
						[% END %]
					[% END %]

					[% IF (item.icon && artwork != 1) || (item.image && artwork== 0) %]
						</div>
					[% END %]
				[%- END %]
			[%- END %]
		[%- END %]

	[%- END %]
[%- END %]

[%- IF hasPagebar; infoTab = BLOCK -%]
	<div>[% "ITEMS" | string %] [% pageinfo.startitem + 1 %] [% "TO" | string %] [% pageinfo.enditem + 1 %] [% "OF" | string %] [% pageinfo.totalitems %]</div>
[%- END; END -%]

[% IF NOT ajaxUpdate %][% IF !streaminfo %]</div>[% END %][% PROCESS pagefooter.html %][% END %]

[% BLOCK itemIcon %]
	[% WRAPPER weblink %]
	<span class="browseCover">
		<img src="[% url | resizeimage(size, size, 'f', webroot) %]" width="[% size %]">
	</span>
	[% END %]
	<div class="[% class %]">
[% END %]

[% BLOCK weblink %]
	[% IF item.weblink %]
		<a href="[% item.weblink %]" target="_blank">
	[% ELSIF item.link %]
		<a href="[% webroot %][% item.link %]&amp;player=[% player | uri %]" target="_blank">
	[% ELSIF item.type == 'redirect' %]
		[% IF item.web.url %]
		<a href="[% webroot %][% item.web.url %]&amp;player=[% player | uri %]" class="browseItemLink">
		[% ELSE; NEXT %]
		[% END %]
	[% ELSIF !item.type.match('^text') %]
		<a href="[% path %]?[% multiquery %][% searchquery | replace("'", "%27") | uri %]index=[% (item.index || index _ (start + loop.index)) | replace("'", "%27") | uri %]&amp;player=[% player | uri %]&amp;sess=[% sess %]" class="browseItemLink">
	[% END %]
	
	[% content %]
	
	[% IF item.weblink || item.link || !item.type.match('^text') %]
		</a>
	[% END %]
[% END %]

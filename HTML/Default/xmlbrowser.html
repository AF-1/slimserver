[%- 
hasArtwork = 0;
contentwrapper = 'contentitem';
container = 'contentcontainer';

FOREACH item = items;
	IF item.image;
		hasArtwork = 1;
		LAST;
	END;	
END;

IF hasArtwork;
	IF artwork == 1;
		container = 'gallerycontainer';
		contentwrapper = 'galleryitem';
	END;
	
	titleRight = BLOCK %]
		<div id="viewSelect"></div>
	[% END; 
END %]

[%- extJsScripts = BLOCK -%]
	<script type="text/javascript" src="[% webroot %]html/Browse.js?r=[% revision %]"></script>

	[% IF hasArtwork %]
	<script type="text/javascript">
		[% PROCESS jsString id='SWITCH_TO_LIST' jsId='switch_to_list' %]
		[% PROCESS jsString id='SWITCH_TO_EXTENDED_LIST' jsId='switch_to_extended_list' %]
		[% PROCESS jsString id='SWITCH_TO_GALLERY' jsId='switch_to_gallery' %]
		[% PROCESS jsString id='ALBUM_DISPLAY_OPTIONS' jsId='display_options' %]
		var orderByList;
	</script>
	[% END %]
[% END %]

[% IF query %]
	[%# Add the search query to each link if available %]
	[% searchquery = 'query=' _ query _ '&amp;' %]
[% END %]

[% FILTER null %]
[% pwd_list = [];
	FOREACH crumb IN crumb;
		crumbItem = BLOCK %]
			<a href="[% path %]?[% searchquery | replace("'", "%27") | uri %]player=[% playerURI %]&amp;index=[% crumb.index %]&amp;sess=[% sess %]">[% crumb.name %]</a>
		[% END %]
		[% pwd_list.push(crumbItem) %]
	[% END %]
[% END # filter -%]

[% IF NOT ajaxUpdate %][% PROCESS pageheader.html dontscroll = (streaminfo ? 0 : 1) %][% IF !streaminfo %]<div id="mainbody">[% END %][% END %]

[% IF msg %][% WRAPPER contentcontainer %]
	<div class="message">[% msg %]</div>
[% END %][% END %]

[% IF streaminfo %]
	[% IF streaminfo.item.enclosure || streaminfo.item.url; songInfoPlayLinks = BLOCK %]
	<div id="songInfoPlayLinks">
		[% WRAPPER playlink %]onclick="SqueezeJS.UI.setProgressCursor();SqueezeJS.Controller.urlRequest(location.pathname + '?[% searchquery | replace("'", "%27") | uri %]action=play&amp;index=[% streaminfo.index %]&amp;player=[% player | uri %]&amp;sess=[% sess %]', false, SqueezeJS.string('connecting_for'));"[% END %]
		[% WRAPPER addlink %]onclick="SqueezeJS.UI.setProgressCursor();SqueezeJS.Controller.urlRequest(location.pathname + '?[% searchquery | replace("'", "%27") | uri %]action=add&amp;index=[% streaminfo.index %]&amp;player=[% player | uri %]&amp;sess=[% sess %]');"[% END %]
	</div>
	[% END; END %]

	[% PROCESS xmlbrowser_details.html %]
[% END %]

[% IF search;
	WRAPPER contentitem controls = xmlSearchControls;
		"SEARCH" | string %]
		<span class="browsedbControls">
			<form id="searchForm" name="searchForm" method="GET">
				<input type="hidden" value="[% player %]" name="player" />
				<input type="hidden" value="[% sess %]" name="sess" />
				<input type="hidden" name="submit" class="stdclick" value="[% "SEARCH" | string %]"/>
				<input type="text" class="x-form-focus searchInput" name="query" value="[% query %]"/>
				<input type="image" src="[% webroot %]html/images/b_search.gif" width="17px" height="17px" alt="[% "SEARCH" | string %]">
			</form>
		</span>					
	[% END;
END %]

[%- IF items.size -%]
	[%- # Maintain correct index values
		FOREACH item = items;
			item.index = index _ (start + loop.index);
		END;
	%]

	<div id="browsedbHeader">
		[% IF hasPagebar %]
			<div class="pagerbox">
				<div class="pagerbox_top"><div></div></div>
				<div class="pagerbox_content">
					[% PROCESS pagebar %]
				</div>
				<div class="pagerbox_bottom"><div></div></div>
			</div>
		[% END %]
	</div>

	[%- BLOCK gencontrol -%]
		[% IF item.favorites == 1 %]
			[% WRAPPER favaddlink noTarget=1 %]
				href="[% path %]?action=favadd&index=[% item.index | replace("'", "%27") | uri %]&amp;start=[% pageinfo.startitem %]&amp;player=[% player | uri %]&amp;sess=[% sess %]"
			[% END %]
		[% ELSIF item.favorites == 2 %]
			[% WRAPPER favdellink noTarget=1 %]
				href="[% path %]?action=favdel&index=[% item.index | replace("'", "%27") | uri %]&amp;start=[% pageinfo.startitem %]&amp;player=[% player | uri %]&amp;sess=[% sess %]"
			[% END %]
		[% END %]

		[% IF item.type == 'audio' || item.type == 'playlist' || item.enclosure || item.play %]
			[% WRAPPER playlink %]onclick="SqueezeJS.UI.setProgressCursor();SqueezeJS.Controller.urlRequest(location.pathname + '?[% searchquery | replace("'", "%27") | uri %]action=play[% IF item.type == 'playlist' %]all[% END %]&amp;index=[% item.index | replace("'", "%27") | uri %]&amp;player=[% player | uri %]&amp;sess=[% sess %]', false, SqueezeJS.string('connecting_for'));"[% END %]
			[% WRAPPER addlink %]onclick="SqueezeJS.UI.setProgressCursor();SqueezeJS.Controller.urlRequest(location.pathname + '?[% searchquery | replace("'", "%27") | uri %]action=add[% IF item.type == 'playlist' %]all[% END %]&amp;index=[% item.index | replace("'", "%27") | uri %]&amp;player=[% player | uri %]&amp;sess=[% sess %]');"[% END %]
		[% ELSE %]
			[% PROCESS dummylink %]
			[% PROCESS dummylink %]
		[% END %]
	[%- END %]

	[%- # treat track information specially
	IF path == 'trackinfo.html';
		details = {};
		mixerlinks = {};

		FOREACH item = items;
			IF item.web;

				IF item.web.type == 'contributor';

					UNLESS details.contributors.${item.web.group}; details.contributors.${item.web.group} = []; END;

					details.contributors.${item.web.group}.push({
						name = item.web.value
						id   = item.db.findCriteria.${'contributor.id'}
					});

				ELSIF item.web.group == 'mixers';

					UNLESS details.${item.web.group}; details.${item.web.group} = []; END;

					details.${item.web.group}.push({
						item = sess
					});

					mixerkey = item.web.item.mixerlinks.keys.0;
					mixerlinks.${mixerkey} = item.web.item.mixerlinks.${mixerkey};

					FOREACH param IN item.web.item.pairs;
						details.mixers.0.${param.key} = param.value;
					END;

				# unfold items which are folded for smaller UIs;
				ELSIF item.web.group && item.items && item.web.unfold;
					UNLESS details.unfold; details.unfold = {}; END;
					UNLESS details.unfold.${item.web.group}; details.unfold.${item.web.group} = {}; END;
					
					details.unfold.${item.web.group}.items = item.items;
					details.unfold.${item.web.group}.start = loop.index;

					# Change the index value for the moreinfo items
					new_index = 0;
					
					FOREACH moreitem = details.unfold.${item.web.group}.items;
						moreitem.index = item.index _ '.' _ new_index;
						new_index = new_index + 1;
					END;

				ELSIF item.web.group;

					UNLESS details.${item.web.group}; details.${item.web.group} = []; END;

					id = item.web.group _ '.id';
					details.${item.web.group}.push({
						name = item.web.value
						id   = item.db.findCriteria.${id}
					});

				END;

			END;
		END;

		new_index = 0;
		FOREACH group = details.unfold.keys;
			start = details.unfold.${group}.start + new_index;
			CALL items.splice(start, 1, details.unfold.${group}.items);
			new_index = details.unfold.${group}.items.max;
		END;

		songInfoPlayLinks = BLOCK; PROCESS songInfoPlayLinks attributes = "&track.id=" _ sess item = details.mixers.0; END;

		PROCESS songinfo_details.html albumFirst = 1 itemobj = {
			id => sess,
			album => details.album.0,
			contributorRoles => details.contributors.keys,
			contributors => details.contributors,
			genres => details.genre,
			year => details.year.0.id
		};

		image = undef;
	END %]


	[%- WRAPPER $container %]
		[% IF image %]
		<div>
			<a href="[% image %]" target="cover">
				<img src="[% image %]" alt="coverArt" onLoad="resize(this)">
			</a>
		</div>
		[% END %]

		[% IF itemsHaveAudio %]
			[%- BLOCK allcontrol -%]
				[% WRAPPER playlink %]onclick="SqueezeJS.UI.setProgressCursor();SqueezeJS.Controller.urlRequest(location.pathname + '?[% searchquery | replace("'", "%27") | uri %]action=playall&amp;index=[% currentIndex %]&amp;player=[% player | uri %]&amp;sess=[% sess %]', false, SqueezeJS.string('connecting_for'));"[% END %]
				[% WRAPPER addlink %]onclick="SqueezeJS.UI.setProgressCursor();SqueezeJS.Controller.urlRequest(location.pathname + '?[% searchquery | replace("'", "%27") | uri %]action=addall&amp;index=[% currentIndex %]&amp;player=[% player | uri %]&amp;sess=[% sess %]');"[% END %]
			[%- END %]
			[%- WRAPPER contentitem controls = 'allcontrol' %]
				[% "ALL_SONGS" | string %]
			[%- END %]
		[% END %]

		[%- FOREACH item = items %]

			[% lctype = item.web.group | lower; IF details.${ lctype } || details.contributors.${item.web.group}; NEXT; END %]

			[% IF item.type == 'search';
				WRAPPER contentitem controls = xmlSearchControls;
					IF artwork == 1;
						itemobj.id = loop.count;
					END;
					item.name || item.title %]
					<span class="browsedbControls">
						<form id="searchForm[% item.index %]" method="GET">
							<input type="hidden" value="[% player %]" name="player" />
							<input type="hidden" value="[% sess %]" name="sess" />
							<input type="hidden" value="[% item.index %]" name="index" />
		 					<input type="hidden" name="submit" class="stdclick" value="[% "SEARCH" | string %]"/>
							<input type="text" class="x-form-focus searchInput" name="q" value=""/>
							<input type="image" src="[% webroot %]html/images/b_search.gif" width="17px" height="17px" alt="[% "SEARCH" | string %]">
						</form>
					</span>					
				[% END %]
			[% ELSE %]
				[%- WRAPPER $contentwrapper controls = 'gencontrol' addClasses = item.type=='text' ? 'defaultCursor' : '' %]
					[% IF artwork == 1 || path == 'trackinfo.html';
						item.size = 100;
						itemobj.id = loop.count;
					END %]

					[% IF item.image && !(artwork > 0) %]
						<span class="browseCover">
							<img src="[% item.image %]" width="50"/>
						</span>
						<div class="browseItemDetail">
					[% END %]

					[% IF item.weblink %]
						<a href="[% item.weblink %]" target="_blank">
					[% ELSIF item.type == 'redirect' %]
						[% IF item.web.url %]
						<a href="[% item.web.url %]&amp;player=[% player | uri %]" class="browseItemLink">
						[% ELSE; NEXT %]
						[% END %]
					[% ELSIF item.type != 'text' %]
						<a href="[% path %]?[% searchquery | replace("'", "%27") | uri %]index=[% item.index | replace("'", "%27") | uri %]&amp;player=[% player | uri %]&amp;sess=[% sess %]" class="browseItemLink">
					[% END %]

					[% item.web.value || item.name || item.title %]

					[% IF item.weblink || item.type != 'text' %]
						</a>
					[% END %]

					[% IF item.image && !(artwork > 0) %]
						</div>
					[% END %]
				[%- END %]
			[%- END %]
		[%- END %]

	[%- END %]
[%- END %]

[%- IF hasPagebar; infoTab = BLOCK -%]
	<div>[% "ITEMS" | string %] [% pageinfo.startitem + 1 %] [% "TO" | string %] [% pageinfo.enditem + 1 %] [% "OF" | string %] [% pageinfo.totalitems %]</div>
[%- END; END -%]

[% IF NOT ajaxUpdate %][% IF !streaminfo %]</div>[% END %][% PROCESS pagefooter.html %][% END %]


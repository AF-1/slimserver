[%- pagetitle = 'SEARCHMUSIC' | string %]
[%- pageicon = icons.SEARCHMUSIC %]
[% extJsScripts = BLOCK %]
	<script type="text/javascript">
		Ext.onReady(function(){
			var sinput = new Ext.form.TextField({
				applyTo: 'livesearch',
				validationDelay: 100,
				validateOnBlur: false,
				selectOnFocus: true,

				searches: [
					[% FOREACH search = searches %]
					{
						id: 'result[% loop.index %]',
						url: '[% search.values.0 %]'
					}[% loop.last ? '' : ',' %]
					[% END %]
				],

				validator: function(value, force){
					var el;

					if (value.length > 2 || force) {
						for (var i=0; i<this.searches.length; i++) {
							if (el = Ext.get(this.searches[i].id)) {
								// don't wait for an earlier update to finish
								if (el.getUpdateManager().isUpdating())
									el.getUpdateManager().abort();

								el.load({
									url: this.searches[i].url,
									method: 'GET',
									params: {
										q: value,
										player: player,
										ajaxUpdate: 1,
										index: i
									},
									callback: function() {
										Highlighter.init();
										SqueezeJS.UI.ScrollPanel.init();

										// we need to fix the URL, as the returned values are relative to the search path
										var a = Ext.DomQuery.select("a[class=browseItemLink]");
										for (i=0; i<a.length; i++) {
											a[i].href = a[i].href.replace(/index.html/g, "clixmlbrowser/clicmd=browselibrary+items&linktitle=SEARCH&mode=search/");
										}
									}
								});
							}
						}
					}

					return true;
				},

				// overwrite default filter to ignore key modifiers
			    filterValidation : function(e){
			        if(!e.isNavKeyPress() && !e.isSpecialKey()){
			            this.validationTask.delay(this.validationDelay);
			        }
			    }
			});

			[% IF manualSearch %]
			sinput.validator('[% query %]', true);
			[% END %]

			new Ext.Button({
				renderTo: 'searchButton',
				text: '[% "SEARCH" | string %]',
				type: 'submit',
				handler: function(){
					document.getElementById("searchForm").submit();
				}
			});
		});
	</script>
[% END %]
[% pwd_list = BLOCK %]
	<a href="search.html?player=[% playerURI %][% IF liveSearch %]&amp;livesearch=1[% END %]">[% "SEARCH" | string %]</a>
[% END %]
[% PROCESS pageheader.html dontscroll=browse_items.size %]

	<div class="searchHeader">
	<form id="searchForm" name="searchForm" method="GET" action="search.html">
		<table><tr>
			<td><input type="text" id="livesearch" name="query" size="30" value="[% query %]" autocomplete="off"/></td>
			<td><span id="searchButton"></span></td>
			<td id="advSearchLink" class="link"><a href="[% webroot %]advanced_search.html?player=[% playerid %]">[% "ADVANCEDSEARCH" | string %]</a></td>
		</tr></table>
		<input type="hidden" value="1" name="manualSearch">
		<input type="hidden" value="[% player %]" name="player">
	</form>
	</div>

	<div id="browsedbHeader">
		[% IF searchError %]
			[% searchError %]
		[% END %]
		[% IF pageinfo.totalpages && pageinfo.totalpages > 1 %]
			<div class="pagerbox">
				<div class="pagerbox_top"><div></div></div>
				<div class="pagerbox_content">
					[% PROCESS pagebar %]
				</div>
				<div class="pagerbox_bottom"><div></div></div>
			</div>
		[% END %]
	</div>

	<div id="browsedblist" class="yo">
	[% FOREACH search = searches %]
		<div class="searchHeader">[% search.keys.0 %]</div>
		<div id="result[% loop.index %]"></div>
	[% END %]
	</div>

[% PROCESS pagefooter.html %]

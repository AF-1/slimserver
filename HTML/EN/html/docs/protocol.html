[SET pageicon help]
[SET title The SLIMP3 Client Protocol]
[SET techinfo 1]
[INCLUDE helpheader.html]

<h4>Overview</h4>

<p><b>Note: This document describes the previous version of the SLIMP3 protocol.  This document will be updated to 
accurately reflect the current protocol.</b>
The SLIMP3 communicates using a custom UDP-based protocol. This protocol
is designed to be extremely light-weight. It gives the server low-level
access to the hardware and full control over the user interface, so as to
mimize the amount of hardware and software required on the client side.
</p>

<p>
All packets are preceded by an 18-byte header. The first byte in this
header is a token which indicates the format of the rest of the header.
Some kinds of packets may have also have variable amount data of
after the header. Variable length data is not delimited - the length is taken from the UDP header. All
numbers are unsigned integers, in network order.
The server listens on port 1069, and replies to the source port of the
packets it receives from the client.
</p>

<p> </p><hr><p> </p>
<h4>Server -> Client</h4>
<p> </p>

<p>
<b>'D' - Discovery response</b>
</p>
<blockquote>

<pre><p>
Field    Value/Description

0        'D' as in "discovery"
1	 reserved
2..5	 server's IP address, or 0.0.0.0
6..7	 server's port
8..17	 reserved
</p></pre>

<p>
On receiving a (d)iscovery request broadcast (see below) from a supported client, the server replies with a unicast
(D)iscovery response, containing the IP and port number that the client should contact. If the server's IP address is left
blank (0.0.0.0), then the client will instead get the IP address and port from the IP/UDP packet headers.  A server replying
to a discovery request may redirect a client to another server (for load balancing) using this mechanism.  If multiple
discovery responses are received, the client will select the first one it receives.
</p>

</blockquote>

<p>
<b>'h' - Say hello</b>
</p>

<blockquote>

<pre><p>
Field    Value/Description

0        'h' as in "hello"
1..17	 reserved
</p></pre>

<p>
This is used by the server to determine if previous known clients are up, and to obtain the model and firmware revision of
those clients. Clients reply with another (h)ello, see below.
</p>
</blockquote>

<p>
<b>'l' - Send data to the lcd/vfd display</b>
</p>
<blockquote>

<pre><p>
Field    Value/Description

0        'l' as in "lcd"
1..17    reserved (ignored)
18...    variable length string of 16-bit codes
</p></pre>

<p>
The Noritake vacuum fluorescent display used in the SLIMP3 implements the
standard Hitachi LCD interface, plus additional codes for controlling
brightness. The data sheet is in CVS under docs/datasheets. The SLIMP3
protocol allows both "character data" and "commands" to be sent directly
to the display. It also allows you to insert a delay between characters.
This is used to insert the required delay after the "clear screen"
command, and can also be used to create animated sequences. The delay
feature is not currently used by the server, and probably shouldn't be
used in its current implementation, because the player has to spin for the
specified time and can not be interrupted. Instead, delays should be
implemented in an interruptible manner on the server side.
</p>

<p>
The 16-bit codes are:
</p>

<pre><p>
00XX, where XX specifies a delay in ms, up to 255
02XX, where XX is a command
03XX, where XX is one of the 256 characters supported by the display
</p></pre>

</blockquote>

<p>
<b>'s' - stream control</b>
</p>
<blockquote>

<pre><p>
Field    Value/Description

0        's' as in "stream"
1        One of three control codes
2	 Delay in ms before executing the command
3..17    Reserved

</p></pre>

<p>
This tells the player to start, pause, or unpause the stream. 
The three control codes are:
</p>

<pre><p>
0x01	Reset the buffer and start a new stream
0x02	Pause playback
0x04	Resume playback
0x08    Enable buffer usage display (for debugging)
</p></pre>

<p>
To synchronize multiple players, combine the "start" and "pause" codes
(0x03) to tell the player to fill its buffer without playing anything.
Then, send "resume" commands to each of the players to make them unpause
the stream. You can specify a delay in ms before the command takes effect,
if necessary.
</p>

<p>
If 0x08 is set, the SLIMP3 will display its buffer usage in the top left corner of the display, 
as an 8-bit hex value. 
</p>

</blockquote>

<p>
<b>'m' - write MPEG data into the player's buffer</b>
</p>

<blockquote>

<pre><p>
Field    Value/Description

0        'm' as in "mpeg"
1        reserved
2..3     16-bit address to write into the player's 1Mbit buffer (16-bit words)
4..17    reserved
18..     variable length string of data (length must be even # of bytes)
</p></pre>


<p>
The operation of the player's buffer and the workings of the streaming
protocol are covered in the
last section of this document, "Streaming".
</p>

</blockquote>

<p>
<b>'2' - read/write the i2c bus</b>
</p>

<blockquote>

<pre><p>

Field    Value/Description

0        '2' as in "i2c"
1..17    reserved
18..     string of i2c commands and data  
</p></pre>

<p>
The protocol allows the i2c bus to be manipulated down to the level of
discrete start / stop / ack / nack / read / write operations. The data
sent after the header is a string of these operations, specified as
follows:
</p>

<pre><p>
wX   write the byte X onto the bus
r    read a byte from the bus
s    start
p    stop
a    ack
n    nack
</p></pre>

<p>
The client acknowledges all i2c packets. See '2' under the
&quot;Client-&gt;Server&quot; section.<p>
</p>

<p>
Please see the <a  
href="http://www-us.semiconductors.philips.com/i2c/facts/"> Philips web
site</a> for more information on i2c. At the bottom of that page, you'll
find
the i2c spec sheet in PDF format.
</p>

</blockquote>

<p> </p><hr><p> </p>
<h4>Client -> Server</h4>

<p>
<b>'d' - Discovery request</b>
</p>

<blockquote>

<pre><p>
Field    Value/Description

0        'd' as in "discovery"
1	 Device ID, '1' for SLIMP3
2	 Firmware rev, eg 0x11 for version 1.1
3..17	 reserved
</p></pre>

<p>
This packet is sent to the broadcast address on port 1069. The client sends this during startup to discover the server's
IP address, after the client has configured his own IP interface. The server replies with a unicast 'D' packet - see above.
</p>

</blockquote>

<p>
<b>'h' - Say hello</b>
</p>

<blockquote>
<pre><p>
Field    Value/Description

0        'h' as in "hello"
1	 Device ID, '1' for SLIMP3
2	 Firmware rev, eg 0x11 for version 1.1
3..17	 reserved
</p></pre>

<p>
The SLIMP3 sends a hello packet to the server when it first starts up, and whenever it receives a hello from the server. This
is for the server to learn that a new client is ready, or for the server to query a client to see if here's still there.
</p>
</blockquote>

<p>
<b>'i' - IR code</b>
</p>

<blockquote>

<pre><p>
Field    Value/Description

0        'i' as in "IR"
1	 0x00
2..5	 player's time since startup in ticks @625 KHz
6        0xFF (will eventually be an identifier 
         for different IR code sets)
7        number of meaningful bits - always 16 (0x10) for JVC
8..11	 the 32-bit IR code
12..17   reserved
</p></pre>
</blockquote>

<p>
<b>'r' - request stream data</b>
</p>
<blockquote>

<p>
<pre>
Field    Value/Description

0        'r' as in "request"
1        reserved
2..3     write pointer (client is requesting data starting 
         at this address)
4..5     read pointer (decoder is currently reading out of 
         the buffer at this address - not implemented yet)
6..17    reserved

</pre>
</p>

</blockquote>

<p>
<b>'2' - i2c response</b>
</p>

<blockquote>
<p>
<pre>
Field    Value/Description

0        '2' as in "i2c"
1..17    reserved
18...    string of bytes in response to the requested i2c 
         read operations, if any
</pre>
</p>

</blockquote>

<p> </p><hr><p> </p>

<h4>Streaming and Buffering</h4>
<p> </p>

<p>
The SLIMP3's buffer chip is a 128K x 8 (1Mbit) SRAM.  It is presented to the server as a 64K
x 16 circular buffer.  The SLIMP3 maintains two pointers, called rptr and wptr, which track
the position at which the DMA controller is reading (out to the decoder) and writing (in
from the network).  When a new stream is started, the SLIMP3 begins by initializing an empty
buffer, with rptr == wptr == 0. It then begins requesting data from the server, starting
from 0. The server replies with some data, which the SLIMP3 writes into the buffer. Once the
buffer reaches 50% capacity, the decoder is started, and the rptr begins to increment. The
SLIMP3 continues requesting data until the buffer is 90% full. Oncee the buffer reaches this
"almost full" state, the SLIMP3 continually checks buffer usage, requesting more data
only when the buffer usage drops below the "almost full" level. 
</p>

<p>
Timeouts due to a lost packet are handled by the client. It the SLIMP3 does not receive a
response from the server after 100ms, then it sends the request again.
</p>

<p>
This is a pretty simple streaming protocol, intended only for use on low-latency networks. A
future protocol will behave in a somewhat TCP-like fashion, with the server handling
timeouts, maintaining multiple packets in flight, and taking responsibility for the client's
buffer. The client will simply acknowledge each packet, instead of requesting data at a
particular offset.  The specification for the new streaming protocol (and why we don't just
use TCP) will be discussed in another document.
</p>

<p> </p><hr><p> </p>

<h4>Other protocols supported by the player</h4>
<p>

<p>
<b>ICMP</b>
</p>

<blockquote>
<p>
ICMP echo (ping): The SLIMP3 will send an ICMP response and display a
message indicating where the ping came from. 
</p>

<p>
ICMP unreachable: This indicates that the server machine is up, but the server process
is not running. The SLIMP3 will display a message to the effect of "10.0.0.1: service
unreachable - are you sure the SLIMP3 server is running?"<p>
</p>

<p>
Other ICMP messages are displayed on the screen in a similar manner, but they are otherwise
ignored (eg ICMP redirect does nothing, but the player will still tell you, so you know to
fix your gateway setting).
</p>
</blockquote>

<p>
<b>UDP echo</b>
</p>

<blockquote>
<p>
The player will echo any packet sent to it on UDP port 7. This could be used to obtain an
RTT estimate. Unlike ping, it does not cause anything to be displayed on the screen.
</p>
</blockquote>

<p>
<b>TCP - experimental/future</b>
</p>
<blockquote>
<p>
Doesn't do much right now. You can connect on port 23 but that's about it.
</p>
</blockquote>

<p>
<b>DHCP</b>
</p>

<blockquote>
<p>
As of firmware version 1.1, the SLIMP3 can use DHCP to discover its own IP address.
</p>
</blockquote>

[INCLUDE helpfooter.html]